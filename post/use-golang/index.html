<!DOCTYPE html>
<html lang="en" class="post hidetop">
<head>
	<meta charset="UTF-8">
	<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
	<meta name='renderer' content='webkit'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no'>
	<meta name='description' content='记录学习的点点滴滴'>
	<meta name='keywords' content='前端,PHP,GO,编程博客'>
	<title>使用golang &middot; 苏苏的博客</title>
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	<link href="" rel="alternate" type="application/rss+xml" title="苏苏的博客" />
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png">
	<link rel="shortcut icon" href="/favicon.png">
</head>
<body>
<header class="header post-header">
    <div class="header-main" >
        <a href="/"><img src="/img/avatar.jpg" class="header-avatar"></a>
        <h1>苏苏的博客</h1>
        <p class="sub-title">简约至极</p>
        <ul class="menus">
            <a href="/">首页</a>
            <a href="/post">技术</a>
            <a href="/life">生活</a>
            <a href="/photo">相册</a>
            <a href="/about">关于</a>
        </ul>
    </div>
    <div class="pull-button">
        <div class="rbutton">
            <svg t="1542524857955" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1684" xmlns:xlink="http://www.w3.org/1999/xlink" width="48" height="48"><defs><style type="text/css"></style></defs><path d="M904 332c0-8.189-3.124-16.379-9.372-22.628-12.497-12.496-32.759-12.496-45.256 0L512 646.745 174.628 309.372c-12.497-12.496-32.758-12.496-45.255 0-12.497 12.498-12.497 32.758 0 45.256l360 360c12.497 12.496 32.758 12.496 45.255 0l360-360C900.876 348.379 904 340.189 904 332z" fill="" p-id="1685"></path></svg>
        </div>
    </div>
</header>
<div class="content container center">
	<div class="post">
		<h1 class="post-title">
			使用golang
        </h1>
        <div class="post-meta">
            <div>
                <p class="post-date">
                    <svg style="width: 26px; height: 16px;position:relative;top:3px;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1946" data-spm-anchor-id="a313x.7781069.0.i0"><path d="M959.381795 958.445982l-895.392924 0 0-740.873688 895.392924 0L959.381795 958.445982zM89.571527 932.863327l844.227614 0 0-689.708378-844.227614 0L89.571527 932.863327z" p-id="1947"></path><path d="M268.650111 64.076364l25.582655 0 0 267.082918-25.582655 0 0-267.082918Z" p-id="1948"></path><path d="M729.137901 64.076364l25.582655 0 0 267.082918-25.582655 0 0-267.082918Z" p-id="1949"></path><path d="M88.54822 408.930553l845.25092 0 0 25.582655-845.25092 0 0-25.582655Z" p-id="1950"></path><path d="M586.898339 651.454122l-139.169643 0 0-114.610294 139.169643 0L586.898339 651.454122zM473.311351 625.871467l88.004333 0 0-63.444984-88.004333 0L473.311351 625.871467z" p-id="1951"></path><path d="M586.898339 831.556013l-139.169643 0 0-115.6336 139.169643 0L586.898339 831.556013zM473.311351 805.973358l88.004333 0 0-64.46829-88.004333 0L473.311351 805.973358z" p-id="1952"></path><path d="M319.815421 651.454122l-141.216255 0 0-114.610294 141.216255 0L319.815421 651.454122zM204.181821 625.871467l90.050945 0 0-63.444984-90.050945 0L204.181821 625.871467z" p-id="1953"></path><path d="M319.815421 831.556013l-141.216255 0 0-115.6336 141.216255 0L319.815421 831.556013zM204.181821 805.973358l90.050945 0 0-64.46829-90.050945 0L204.181821 805.973358z" p-id="1954"></path><path d="M856.027869 651.454122l-139.169643 0 0-114.610294 139.169643 0L856.027869 651.454122zM742.440881 625.871467l88.004333 0 0-63.444984-88.004333 0L742.440881 625.871467z" p-id="1955"></path><path d="M856.027869 831.556013l-139.169643 0 0-115.6336 139.169643 0L856.027869 831.556013zM742.440881 805.973358l88.004333 0 0-64.46829-88.004333 0L742.440881 805.973358z" p-id="1956"></path></svg>
                    2016/05/07 14:38 Sat
                </p>
            </div>

            
            

            
            
        </div>
        
		<div class="post-text">
			

<h2 id="go">Go</h2>

<p><a href="https://www.oschina.net/news/93422/go-1-10-released">https://www.oschina.net/news/93422/go-1-10-released</a></p>

<pre><code>https://storage.googleapis.com/golang/go1.11.linux-amd64.tar.gz
https://storage.googleapis.com/golang/go1.11.windows-amd64.msi

</code></pre>

<p>所有发布的版本</p>

<p><code>https://storage.googleapis.com/golang/</code></p>

<p>国内可访问地址</p>

<pre><code>https://dl.google.com/go/go1.11.windows-amd64.msi
https://dl.google.com/go/go1.11.darwin-amd64.pkg
https://dl.google.com/go/go1.11.linux-amd64.tar.gz
https://dl.google.com/go/go1.11.src.tar.gz
https://dl.google.com/go/go1.11.darwin-amd64.tar.gz
https://dl.google.com/go/go1.11.linux-386.tar.gz
https://dl.google.com/go/go1.11.linux-armv6l.tar.gz
https://dl.google.com/go/go1.11.windows-386.zip
https://dl.google.com/go/go1.11.windows-386.msi
https://dl.google.com/go/go1.11.windows-amd64.zip
https://dl.google.com/go/go1.11.freebsd-386.tar.gz
https://dl.google.com/go/go1.11.freebsd-amd64.tar.gz
https://dl.google.com/go/go1.11.linux-arm64.tar.gz
https://dl.google.com/go/go1.11.linux-ppc64le.tar.gz
https://dl.google.com/go/go1.11.linux-s390x.tar.gz
</code></pre>

<h2 id="creating-statically-linked-executables-in-go">Creating Statically Linked Executables In Go</h2>

<p><a href="https://joeshaw.org/smaller-docker-containers-for-go-apps/">https://joeshaw.org/smaller-docker-containers-for-go-apps/</a></p>

<p><a href="https://github.com/gliderlabs/docker-alpine">https://github.com/gliderlabs/docker-alpine</a></p>

<pre><code>CGO_ENABLED=0 go build -a -ldflags &quot;-s&quot; tiny.go
</code></pre>

<p>The CGO_ENABLED environment variable tells Go to use the go compiler rather than the cgo compiler. The -a flag tells Go to rebuild all dependencies. Otherwise you still end up with dynamically linked dependencies. And finally the -ldflags &lsquo;-s&rsquo; flag is a nice extra. It reduces the file size of the resulting executable by roughly 50%. You can also do this without the go compiler. The size reduction is a result from removing debug information.</p>

<p>GO原生支持跨平台编译,可以直接在Mac上生成Linux可执行程序,和Windows上的exe程序</p>

<p>生成Linux上64位:<code>CGO_ENABLED=0 GOOS=linux GOARCH=amd64  go build -a -ldflags &quot;-s -w&quot; tiny.go</code></p>

<p>生成Windows上64位:<code>CGO_ENABLED=0 GOOS=windows GOARCH=amd64  go build -a -ldflags &quot;-s -w&quot; tiny.go</code></p>

<p>编译32位程序,可以改为<code>GOARCH=386</code></p>

<p>Linux arm 编译 <code>CGO_ENABLED=0 GOOS=linux GOARCH=arm64  go build -a -ldflags &quot;-s -w&quot; tiny.go</code></p>

<p><code>CGO_ENABLED=0 GOARM=7 GOOS=linux GOARCH=arm  go build -a -ldflags &quot;-s -w&quot; tiny.go</code></p>

<p>-a 参数指明所有的引用也进行编译打包到可执行程序,可以完成静态编译.</p>

<p>ldflags:</p>

<blockquote>
<p><code>-s</code> 指明需要经过<code>strip</code>,去除调试信息,使生成的可执行文件更小.
<code>-w</code> 也能减少文件的大小</p>
</blockquote>

<p>参数含义见 <a href="https://golang.org/cmd/link/">https://golang.org/cmd/link/</a></p>

<p><strong>使编译后的文件更小的办法</strong></p>

<ol>
<li><p>使用<code>go build -ldflags &quot;-s -w&quot;</code>来编译文件.此时生成的文件,去除了调试信息,文件体积尽量缩减.</p></li>

<li><p>Go 1.6及以后版本直接使用<code>upx</code>进一步减少体积,1.6之前版本还需要使用<code>goupx</code></p></li>
</ol>

<p><code>upx</code>使用见 <a href="https://upx.github.io/">https://upx.github.io/</a></p>

<p>mac用户可以使用<code>brew install upx</code>安装</p>

<h2 id="设置gopath环境变量">设置GOPATH环境变量</h2>

<p><code>export GOPATH=/home/apple/mygo</code>
GOPATH允许多个目录，当有多个目录时，请注意分隔符，多个目录的时候Windows是分号，Linux系统是冒号，当有多个GOPATH时，默认会将go get的内容放在第一个目录下</p>

<p>$GOPATH 目录约定有三个子目录：</p>

<ul>
<li>src 存放源代码（比如：.go .c .h .s等）</li>
<li>pkg 编译后生成的文件（比如：.a）</li>
<li>bin 编译后生成的可执行文件(为了方便，可以把此目录加入到 $PATH 变量中)</li>
</ul>

<h3 id="golang-程序性能分析">golang 程序性能分析</h3>

<p>查看或生成性能图表需要安装<code>graphviz</code></p>

<p><code>brew install graphviz</code> 或者 <code>yum -y install graphviz</code></p>

<p><code>go tool pprof main profile_file</code></p>

<p><code>top10</code> 查看最消耗资源的调用</p>

<p><code>web</code></p>

<p>top命令可以看最耗时的function。它的输出格式各字段的含义依次是：</p>

<pre><code>采样点落在该函数中的次数
采样点落在该函数中的百分比
上一项的累积百分比
采样点落在该函数，以及被它调用的函数中的总次数
采样点落在该函数，以及被它调用的函数中的总次数百分比
函数名
</code></pre>

<p>HeapAlloc: essentially what the profiler is giving you (active heap memory)
Alloc: similar to HeapAlloc, but for all go managed memory
Sys: the total amount of memory (address space) requested from the OS</p>

<p>设置变量 <code>GODEBUG=&quot;gctrace=1&quot;</code> 可以监控gc执行时在控制台打印出信息.</p>

<p>import <code>_ &quot;net/http/pprof&quot;</code></p>

<p><code>go tool pprof http://localhost:6060/debug/pprof/heap</code></p>

<p><code>go get -u -v github.com/davecheney/gcvis</code></p>

<p><a href="https://dave.cheney.net/2014/07/11/visualising-the-go-garbage-collector">https://dave.cheney.net/2014/07/11/visualising-the-go-garbage-collector</a></p>

<p><code>go build -gcflags=-m fastload/fastload.go</code></p>

<p>编译任何一个文件,查看他的逃逸分析,和内联函数的优化</p>

<p>逃逸分析是在编译时而不是运行的时候做的。</p>

<p>无论垃圾回收机制多么高效，栈的分配总是比堆的分配要快。</p>

<p>在栈上存储的变量不需要特别的分配和释放操作,栈上分配的会在函数返回时释放内存,不需要垃圾回收机制.</p>

<p>在堆（heap）上分配内存是有代价的。每次垃圾回收机制触发都会消耗一定的CPU。除非内存都被释放了，这些开销是不可避免的。</p>

<p><img src="https://i.loli.net/2017/10/26/59f15cefa8e3e.png" alt="golang内存" /></p>

<h3 id="golang-性能火焰图">golang 性能火焰图</h3>

<p><strong>安装go-torch</strong></p>

<p><code>go get -v github.com/uber/go-torch</code></p>

<p><code>wget https://raw.githubusercontent.com/brendangregg/FlameGraph/master/flamegraph.pl</code></p>

<p>在终端输入 flamegraph.pl -h 是否安装FlameGraph成功</p>

<p>启用待调优的程序</p>

<p><code>import _ &quot;net/http/pprof&quot;</code></p>

<p><code>go run main.go</code></p>

<p>使用测压工具或手动模拟测试</p>

<p><code>go-torch -u http://localhost:6060 -t 30</code> 采样30秒,生成火焰图.会自动生成svg文件,我们用浏览器打开svg文件就可以查看分析了.</p>

<p>也可以执行 <code>go tool pprof --seconds 25 http://localhost:6060/debug/pprof/profile</code> 使用 golang自带的工具采样,然后使用<code>web</code>命令生成svg文件并查看.</p>

<h3 id="golang-优化">golang 优化</h3>

<ol>
<li>字符串与数组相互转化时发生复制</li>
<li>array 以 pass-by-value 方式传递，函数调用会发生复制，但不是总要避免这种复制，对于一些短小的对象，复制成本远小于在堆上分配和回收操作</li>
<li>defer 滥用引起的问题</li>
<li>避免频繁穿件go</li>
</ol>

<p><a href="https://segmentfault.com/u/qyuhen/articles">https://segmentfault.com/u/qyuhen/articles</a></p>

<h3 id="golang-指针">golang 指针</h3>

<p>用不用指针取决2个方面</p>

<blockquote>
<p>1， 大小（go是传值的），数据太大， 压栈浪费内存
2， 你有还函数内部修改，并保证外部可见的需求</p>
</blockquote>

<p>go 不区分堆和栈,或者说,go自己处理这些问题，和用户无关，用户也不可知</p>

<p>什么情况下不使用指针</p>

<blockquote>
<ol>
<li>数据太小,小于指针大小,或者你可以容忍传值开销</li>
<li>明确需求传值,通常希望修改对外部不可见情况</li>
<li>类型内部是通过指针引用数据的(例如map,slice) 或者数据本身就是指针</li>
<li>如果不理解或不清楚上述三点是否适用,一律适用指针</li>
</ol>
</blockquote>

<p>Go语言的指针，基本上只用于区分 byref 和 byval 语义</p>

<p>运算符就是简单的 &amp; 和 * 一个取地址、一个解析地址。</p>

<p>传值与传指针
当我们传一个参数值到被调用函数里面时，实际上是传了这个值的一份copy，当在被调用函数中修改参数值的时候，调用函数中相应实参不会发生任何变化，因为数值变化只作用在copy上。</p>

<p>传指针比较轻量级 (8bytes),只是传内存地址，我们可以用指针传递体积大的结构体。如果用参数值传递的话, 在每次copy上面就会花费相对较多的系统开销（内存和时间）。所以当你要传递大的结构体的时候，用指针是一个明智的选择。</p>

<p>Go语言中string，slice，map这三种类型的实现机制类似指针，所以可以直接传递，而不用取地址后传递指针。（注：若函数需改变slice的长度，则仍需要取地址传递指针）</p>

<h2 id="调试">调试</h2>

<p><a href="https://github.com/derekparker/delve">https://github.com/derekparker/delve</a></p>

<p><code>dvl attach pid</code></p>

<h2 id="golang-bin">golang bin</h2>

<p>一些常用的golang 可执行程序</p>

<pre><code>
# google drive
go get -u -v 'github.com/prasmussen/gdrive'

# 16进制编辑器
go get -u -v github.com/itchyny/bed/cmd/bed

# 压力测试工具
go get -u -v github.com/tsenart/vegeta

# ossutil
go get -u -v github.com/aliyun/ossutil
</code></pre>

<p>其他语言里的协程</p>

<p><a href="https://owent.net/2018/1806.html">https://owent.net/2018/1806.html</a></p>

		</div>
    </div>
    <div class="post-comment comment-render">
        <air-messager ns="hi" kid="/post/use-golang/"></air-messager>
    </div>
    <div class="post-end">
        
            <a class="previous" href="http://blog.suconghou.cn/post/vim-usage/" title="vim基本使用" >
                <svg t="1542528774445" class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1114"><path d="M532.526499 904.817574L139.506311 511.797385 532.526499 118.777197c12.258185-12.258185 12.432147-32.892131-0.187265-45.51052-12.707416-12.707416-32.995485-12.703323-45.511543-0.187265L75.166957 484.739123c-7.120165 7.120165-10.163477 17.065677-8.990768 26.624381-1.500167 9.755178 1.5104 20.010753 8.990768 27.491121l411.660734 411.660734c12.258185 12.258185 32.892131 12.432147 45.511543-0.187265 12.707416-12.707416 12.7023-32.995485 0.187265-45.51052z" p-id="1115"></path></svg>
            </a>
        
        
            <a class="next" href="http://blog.suconghou.cn/post/use-docker-on-raspberry/" title="在树莓派上使用Docker">
                <svg t="1542528747675" class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="997" data-spm-anchor-id="a313x.7781069.0.i0"><path d="M492.675886 904.817574L885.696074 511.797385 492.675886 118.777197c-12.258185-12.258185-12.432147-32.892131 0.187265-45.51052 12.707416-12.707416 32.995485-12.703323 45.511543-0.187265l411.660734 411.660734c7.120165 7.120165 10.163477 17.065677 8.990768 26.624381 1.500167 9.755178-1.5104 20.010753-8.990768 27.491121L538.374694 950.515359c-12.258185 12.258185-32.892131 12.432147-45.511543-0.187265-12.707416-12.707416-12.703323-32.995485-0.187265-45.51052z" p-id="998"></path></svg>
            </a>
        
    </div>
</div>
<footer class="footer">
    <div class="footer-nav">
    </div>
</footer>
<script type="text/javascript" src="/js/main.js"></script>
<script src="https://lib.baomitu.com/vue/2.5.17/vue.min.js"></script>
<script src="http://feds.club/static/air-messager.min.js"></script>
</body>
</html>
